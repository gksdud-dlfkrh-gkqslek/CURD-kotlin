<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì¥ë¹„ ì˜ˆì•½ ì‹œìŠ¤í…œ</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --bg:          #f0f2f7;
      --surface:     #ffffff;
      --border:      #e2e6f0;
      --border2:     #cdd2e4;
      --accent:      #2563eb;
      --accent-lt:   #eff4ff;
      --accent2:     #7c3aed;
      --green:       #059669;
      --green-bg:    #ecfdf5;
      --red:         #dc2626;
      --red-bg:      #fef2f2;
      --yellow:      #d97706;
      --yellow-bg:   #fffbeb;
      --text:        #111827;
      --text-sub:    #374151;
      --text-muted:  #6b7280;
      --text-dim:    #9ca3af;
      --shadow:      0 1px 3px rgba(0,0,0,.08),0 4px 16px rgba(0,0,0,.04);
      --shadow-md:   0 4px 12px rgba(0,0,0,.10),0 8px 32px rgba(0,0,0,.06);
      --shadow-lg:   0 12px 40px rgba(0,0,0,.15);
    }
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Noto Sans KR',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}

    /* â”€â”€ HEADER â”€â”€ */
    header{background:var(--surface);border-bottom:1px solid var(--border);height:56px;display:flex;align-items:center;justify-content:space-between;padding:0 1.5rem;position:sticky;top:0;z-index:100;box-shadow:0 1px 0 var(--border);}
    .logo{display:flex;align-items:center;gap:.5rem;font-family:'JetBrains Mono',monospace;font-size:.9rem;font-weight:600;color:var(--accent);}
    .logo-icon{width:28px;height:28px;background:var(--accent);border-radius:7px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:.85rem;}
    .header-right{display:flex;align-items:center;gap:.8rem;}
    .user-chip{display:flex;align-items:center;gap:.5rem;background:var(--bg);border:1px solid var(--border);border-radius:999px;padding:.25rem .75rem .25rem .25rem;font-size:.8rem;color:var(--text-sub);}
    .avatar{width:26px;height:26px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:700;color:#fff;}
    .btn-logout{height:32px;padding:0 .8rem;border:1px solid var(--border2);background:var(--surface);color:var(--text-muted);border-radius:7px;cursor:pointer;font-size:.78rem;font-family:'Noto Sans KR',sans-serif;transition:all .15s;}
    .btn-logout:hover{border-color:var(--red);color:var(--red);background:var(--red-bg);}

    /* â”€â”€ LAYOUT â”€â”€ */
    .layout{display:grid;grid-template-columns:220px 1fr;min-height:calc(100vh - 56px);}

    /* â”€â”€ SIDEBAR â”€â”€ */
    aside{background:var(--surface);border-right:1px solid var(--border);padding:1.25rem .75rem;display:flex;flex-direction:column;gap:1rem;}
    .profile-block{background:linear-gradient(135deg,var(--accent) 0%,var(--accent2) 100%);border-radius:12px;padding:1.2rem;color:#fff;position:relative;overflow:hidden;}
    .profile-block::before{content:'';position:absolute;top:-20px;right:-20px;width:80px;height:80px;border-radius:50%;background:rgba(255,255,255,.08);}
    .profile-block::after{content:'';position:absolute;bottom:-30px;left:-10px;width:100px;height:100px;border-radius:50%;background:rgba(255,255,255,.05);}
    .profile-av{width:44px;height:44px;border-radius:12px;background:rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;font-size:1.1rem;font-weight:800;color:#fff;margin-bottom:.7rem;}
    .profile-name{font-size:.95rem;font-weight:700;margin-bottom:.15rem;position:relative;z-index:1;}
    .profile-phone{font-size:.72rem;opacity:.8;font-family:'JetBrains Mono',monospace;position:relative;z-index:1;}
    .profile-role{display:inline-block;margin-top:.5rem;padding:.1rem .5rem;background:rgba(255,255,255,.2);border-radius:999px;font-size:.68rem;font-weight:600;letter-spacing:.06em;position:relative;z-index:1;}
    .stats-mini{display:grid;grid-template-columns:1fr 1fr;gap:.5rem;}
    .stat-mini{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:.6rem .7rem;}
    .stat-mini-label{font-size:.65rem;color:var(--text-muted);margin-bottom:.2rem;}
    .stat-mini-val{font-size:1.1rem;font-weight:800;font-family:'JetBrains Mono',monospace;color:var(--accent);}
    nav{display:flex;flex-direction:column;gap:.2rem;}
    .nav-label{font-size:.65rem;font-weight:700;color:var(--text-dim);letter-spacing:.1em;text-transform:uppercase;padding:0 .5rem;margin-bottom:.2rem;}
    .nav-item{display:flex;align-items:center;gap:.6rem;padding:.55rem .75rem;border-radius:8px;cursor:pointer;font-size:.83rem;color:var(--text-muted);transition:all .15s;border:none;background:none;width:100%;text-align:left;font-family:'Noto Sans KR',sans-serif;font-weight:500;}
    .nav-item:hover{background:var(--bg);color:var(--text-sub);}
    .nav-item.active{background:var(--accent-lt);color:var(--accent);font-weight:600;}
    .nav-icon{font-size:.9rem;}
    .nav-count{margin-left:auto;background:var(--accent);color:#fff;border-radius:999px;font-size:.65rem;font-weight:700;padding:.1rem .45rem;min-width:18px;text-align:center;}

    /* â”€â”€ MAIN â”€â”€ */
    main{padding:1.75rem;overflow-y:auto;}
    .section{display:none;}
    .section.active{display:block;animation:fadeIn .2s ease;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
    .page-head{display:flex;align-items:flex-end;justify-content:space-between;margin-bottom:1.25rem;}
    .page-title{font-size:1.2rem;font-weight:800;}
    .page-sub{font-size:.78rem;color:var(--text-muted);margin-top:.15rem;}

    /* â”€â”€ STATS â”€â”€ */
    .stats-row{display:grid;grid-template-columns:repeat(3,1fr);gap:.8rem;margin-bottom:1.25rem;}
    .stat-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:1rem 1.1rem;box-shadow:var(--shadow);display:flex;align-items:center;gap:.9rem;}
    .stat-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0;}
    .stat-icon.blue{background:#eff6ff;}
    .stat-icon.green{background:#f0fdf4;}
    .stat-icon.amber{background:#fffbeb;}
    .stat-label{font-size:.72rem;color:var(--text-muted);margin-bottom:.15rem;}
    .stat-val{font-size:1.5rem;font-weight:800;font-family:'JetBrains Mono',monospace;}
    .stat-val.blue{color:var(--accent);}
    .stat-val.green{color:var(--green);}
    .stat-val.amber{color:var(--yellow);}

    /* â”€â”€ TOOLBAR â”€â”€ */
    .toolbar{display:flex;align-items:center;gap:.6rem;margin-bottom:.8rem;}
    .search-wrap{flex:1;max-width:280px;position:relative;}
    .search-wrap input{width:100%;height:34px;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:0 .8rem 0 2rem;font-size:.8rem;font-family:'Noto Sans KR',sans-serif;color:var(--text);outline:none;transition:border-color .15s;}
    .search-wrap input:focus{border-color:var(--accent);}
    .search-wrap input::placeholder{color:var(--text-dim);}
    .search-icon{position:absolute;left:.6rem;top:50%;transform:translateY(-50%);color:var(--text-dim);font-size:.8rem;}
    .btn-refresh{height:34px;padding:0 .8rem;background:var(--surface);border:1px solid var(--border);border-radius:8px;cursor:pointer;font-size:.78rem;color:var(--text-muted);font-family:'Noto Sans KR',sans-serif;transition:all .15s;display:flex;align-items:center;gap:.3rem;}
    .btn-refresh:hover{border-color:var(--accent);color:var(--accent);}

    /* â”€â”€ TABLE â”€â”€ */
    .table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);overflow:hidden;}
    table{width:100%;border-collapse:collapse;}
    thead tr{background:#f8f9fc;}
    th{padding:.7rem 1rem;text-align:left;font-size:.7rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:.07em;border-bottom:1px solid var(--border);white-space:nowrap;}
    td{padding:.8rem 1rem;font-size:.82rem;border-bottom:1px solid var(--border);vertical-align:middle;}
    tr:last-child td{border-bottom:none;}
    tbody tr{transition:background .1s;}
    tbody tr:hover td{background:#f9fafc;}
    .mono{font-family:'JetBrains Mono',monospace;font-size:.72rem;color:var(--text-muted);}
    .badge{display:inline-flex;align-items:center;gap:.3rem;padding:.18rem .6rem;border-radius:999px;font-size:.72rem;font-weight:600;white-space:nowrap;}
    .badge::before{content:'â—';font-size:.5rem;}
    .badge.normal{background:var(--green-bg);color:var(--green);}
    .badge.repair{background:var(--yellow-bg);color:var(--yellow);}
    .badge.broken{background:var(--red-bg);color:var(--red);}
    .badge.available{background:var(--green-bg);color:var(--green);}
    .badge.rsv-yes{background:var(--red-bg);color:var(--red);}
    .btn-reserve{height:28px;padding:0 .75rem;border-radius:6px;font-size:.75rem;font-weight:600;cursor:pointer;border:none;font-family:'Noto Sans KR',sans-serif;transition:all .15s;white-space:nowrap;}
    .btn-reserve.can{background:var(--accent);color:#fff;}
    .btn-reserve.can:hover{background:#1d4ed8;transform:translateY(-1px);box-shadow:0 2px 8px rgba(37,99,235,.3);}
    .btn-reserve.mine{background:var(--red-bg);color:var(--red);border:1px solid #fecaca;cursor:default;}
    .btn-reserve.off{background:var(--bg);color:var(--text-dim);border:1px solid var(--border);cursor:not-allowed;}

    /* â”€â”€ MY RESERVATIONS â”€â”€ */
    .res-list{display:flex;flex-direction:column;gap:.7rem;}
    .res-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:1rem 1.2rem;display:flex;align-items:center;gap:1rem;box-shadow:var(--shadow);transition:all .15s;animation:fadeIn .2s ease;}
    .res-card:hover{border-color:var(--accent);box-shadow:var(--shadow-md);}
    .res-icon{width:42px;height:42px;border-radius:10px;background:var(--accent-lt);display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0;}
    .res-body{flex:1;}
    .res-name{font-size:.9rem;font-weight:700;margin-bottom:.25rem;}
    .res-dates{display:flex;gap:1rem;flex-wrap:wrap;}
    .res-date-chip{display:flex;align-items:center;gap:.3rem;font-size:.72rem;color:var(--text-muted);background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:.15rem .5rem;font-family:'JetBrains Mono',monospace;}
    .res-date-chip .label{font-size:.65rem;color:var(--text-dim);font-family:'Noto Sans KR',sans-serif;}
    .btn-cancel{height:30px;padding:0 .8rem;border:1px solid #fecaca;background:var(--red-bg);color:var(--red);border-radius:7px;cursor:pointer;font-size:.75rem;font-weight:600;font-family:'Noto Sans KR',sans-serif;transition:all .15s;white-space:nowrap;flex-shrink:0;}
    .btn-cancel:hover{background:var(--red);color:#fff;}

    /* â”€â”€ LOADING / EMPTY â”€â”€ */
    .loading-box{display:flex;align-items:center;justify-content:center;padding:3.5rem;color:var(--text-muted);font-size:.82rem;gap:.5rem;}
    .spinner{width:16px;height:16px;border:2px solid var(--border2);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg)}}
    .empty-box{text-align:center;padding:3.5rem;color:var(--text-muted);}
    .empty-box .ei{font-size:2.5rem;margin-bottom:.6rem;}
    .empty-box p{font-size:.82rem;}

    /* â”€â”€ MODAL OVERLAY â”€â”€ */
    .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(3px);z-index:300;align-items:center;justify-content:center;}
    .modal-overlay.show{display:flex;}
    .modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:2rem;width:100%;max-width:400px;box-shadow:var(--shadow-lg);animation:modalIn .25s cubic-bezier(.34,1.56,.64,1);}
    @keyframes modalIn{from{opacity:0;transform:scale(.92) translateY(10px)}to{opacity:1;transform:scale(1) translateY(0)}}
    .modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.25rem;}
    .modal-title{font-size:1rem;font-weight:800;}
    .modal-close{width:28px;height:28px;border:none;background:var(--bg);border-radius:6px;cursor:pointer;font-size:1rem;color:var(--text-muted);display:flex;align-items:center;justify-content:center;transition:all .15s;}
    .modal-close:hover{background:var(--border);color:var(--text);}
    .modal-body{display:flex;flex-direction:column;gap:1rem;}
    .modal-eq-info{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:.9rem 1rem;display:flex;flex-direction:column;gap:.3rem;}
    .modal-eq-name{font-size:.9rem;font-weight:700;}
    .modal-eq-meta{font-size:.75rem;color:var(--text-muted);font-family:'JetBrains Mono',monospace;}
    .form-group{display:flex;flex-direction:column;gap:.4rem;}
    .form-label{font-size:.8rem;font-weight:600;color:var(--text-sub);}
    .form-label span{color:var(--red);}
    .form-input{height:38px;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:0 .9rem;font-size:.82rem;font-family:'Noto Sans KR',sans-serif;color:var(--text);outline:none;transition:border-color .15s;width:100%;}
    .form-input:focus{border-color:var(--accent);}
    .form-hint{font-size:.72rem;color:var(--text-dim);}
    .form-date-row{display:grid;grid-template-columns:1fr 1fr;gap:.75rem;}
    .form-date-box{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:.65rem .8rem;}
    .form-date-label{font-size:.65rem;color:var(--text-dim);margin-bottom:.2rem;}
    .form-date-val{font-size:.82rem;font-weight:600;font-family:'JetBrains Mono',monospace;color:var(--text-sub);}
    .modal-footer{display:flex;gap:.6rem;margin-top:.5rem;}
    .btn-modal-cancel{flex:1;height:40px;border:1px solid var(--border2);background:var(--surface);color:var(--text-muted);border-radius:8px;cursor:pointer;font-size:.85rem;font-family:'Noto Sans KR',sans-serif;transition:all .15s;}
    .btn-modal-cancel:hover{background:var(--bg);}
    .btn-modal-confirm{flex:2;height:40px;background:var(--accent);color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:.85rem;font-weight:700;font-family:'Noto Sans KR',sans-serif;transition:all .15s;}
    .btn-modal-confirm:hover{background:#1d4ed8;}
    .btn-modal-confirm:disabled{background:var(--text-dim);cursor:not-allowed;}

    /* â”€â”€ CONFIRM MODAL â”€â”€ */
    .confirm-modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:1.75rem;width:100%;max-width:340px;box-shadow:var(--shadow-lg);text-align:center;animation:modalIn .25s cubic-bezier(.34,1.56,.64,1);}
    .confirm-icon{font-size:2.2rem;margin-bottom:.8rem;}
    .confirm-title{font-size:1rem;font-weight:800;margin-bottom:.4rem;}
    .confirm-desc{font-size:.82rem;color:var(--text-muted);margin-bottom:1.3rem;line-height:1.6;}
    .confirm-btns{display:flex;gap:.6rem;}
    .btn-confirm-no{flex:1;height:38px;border:1px solid var(--border2);background:var(--surface);color:var(--text-muted);border-radius:8px;cursor:pointer;font-size:.82rem;font-family:'Noto Sans KR',sans-serif;}
    .btn-confirm-yes{flex:1;height:38px;background:var(--red);color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:.82rem;font-weight:700;font-family:'Noto Sans KR',sans-serif;}

    /* â”€â”€ TOAST â”€â”€ */
    .toast{position:fixed;bottom:1.5rem;right:1.5rem;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:.7rem 1.1rem;font-size:.82rem;box-shadow:var(--shadow-md);display:flex;align-items:center;gap:.5rem;transform:translateY(12px);opacity:0;transition:all .25s cubic-bezier(.34,1.56,.64,1);z-index:999;pointer-events:none;}
    .toast.show{opacity:1;transform:translateY(0);}
    .toast.success{border-color:#bbf7d0;color:var(--green);}
    .toast.error{border-color:#fecaca;color:var(--red);}
    .toast.info{border-color:#bfdbfe;color:var(--accent);}

    /* â”€â”€ UNAUTH â”€â”€ */
    #unauth{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);backdrop-filter:blur(4px);z-index:200;align-items:center;justify-content:center;}
    #unauth.show{display:flex;}
    .unauth-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:2rem;text-align:center;max-width:320px;width:90%;box-shadow:var(--shadow-md);}
    .unauth-card .icon{font-size:2.5rem;margin-bottom:.8rem;}
    .unauth-card h3{font-size:1rem;font-weight:700;margin-bottom:.4rem;}
    .unauth-card p{font-size:.8rem;color:var(--text-muted);margin-bottom:1.2rem;}
    .btn-login{display:inline-block;padding:.5rem 1.5rem;background:var(--accent);color:#fff;border-radius:8px;font-size:.85rem;font-weight:600;cursor:pointer;border:none;font-family:'Noto Sans KR',sans-serif;}
  </style>
</head>
<body>

<!-- ë¯¸ì¸ì¦ ì˜¤ë²„ë ˆì´ -->
<div id="unauth">
  <div class="unauth-card">
    <div class="icon">ğŸ”’</div>
    <h3>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</h3>
    <p>ì´ í˜ì´ì§€ë¥¼ ì´ìš©í•˜ë ¤ë©´ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.</p>
    <button class="btn-login" onclick="location.href='/login.html'">ë¡œê·¸ì¸í•˜ëŸ¬ ê°€ê¸°</button>
  </div>
</div>

<!-- ì˜ˆì•½ ëª¨ë‹¬ -->
<div class="modal-overlay" id="reserveModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">ğŸ–¥ ì¥ë¹„ ì˜ˆì•½</div>
      <button class="modal-close" onclick="closeReserveModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="modal-eq-info">
        <div class="modal-eq-name" id="modalEqName">-</div>
        <div class="modal-eq-meta" id="modalEqMeta">-</div>
      </div>

      <div class="form-date-row">
        <div class="form-date-box">
          <div class="form-date-label">ì˜ˆì•½ì¼</div>
          <div class="form-date-val" id="modalReservedDate">-</div>
        </div>
        <div class="form-date-box">
          <div class="form-date-label">ì˜¤ëŠ˜ ê¸°ì¤€</div>
          <div class="form-date-val" id="modalToday">-</div>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">ë°˜ë‚©ì¼ <span>*</span></label>
        <input type="date" class="form-input" id="deadlineInput" oninput="validateDeadline()"/>
        <div class="form-hint" id="deadlineHint">ë°˜ë‚©í•  ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš” (ì˜¤ëŠ˜ ì´í›„)</div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-modal-cancel" onclick="closeReserveModal()">ì·¨ì†Œ</button>
      <button class="btn-modal-confirm" id="confirmReserveBtn" onclick="submitReserve()" disabled>ì˜ˆì•½ í™•ì •</button>
    </div>
  </div>
</div>

<!-- ì˜ˆì•½ ì·¨ì†Œ í™•ì¸ ëª¨ë‹¬ -->
<div class="modal-overlay" id="cancelModal">
  <div class="confirm-modal">
    <div class="confirm-icon">âš ï¸</div>
    <div class="confirm-title">ì˜ˆì•½ì„ ì·¨ì†Œí•˜ì‹œê² ì–´ìš”?</div>
    <div class="confirm-desc" id="cancelModalDesc">í•´ë‹¹ ì¥ë¹„ì˜ ì˜ˆì•½ì´ ì·¨ì†Œë©ë‹ˆë‹¤.</div>
    <div class="confirm-btns">
      <button class="btn-confirm-no"  onclick="closeCancelModal()">ëŒì•„ê°€ê¸°</button>
      <button class="btn-confirm-yes" onclick="submitCancel()">ì·¨ì†Œ í™•ì •</button>
    </div>
  </div>
</div>

<!-- Header -->
<header>
  <div class="logo">
    <div class="logo-icon">âš™</div>
    EQUIPÂ·RESERVE
  </div>
  <div class="header-right">
    <div class="user-chip">
      <div class="avatar" id="hAvatar">?</div>
      <span id="hName">ë¡œë”©ì¤‘...</span>
    </div>
    <button class="btn-logout" onclick="doLogout()">ë¡œê·¸ì•„ì›ƒ</button>
  </div>
</header>

<div class="layout">
  <aside>
    <div class="profile-block">
      <div class="profile-av"    id="pAvatar">?</div>
      <div class="profile-name"  id="pName">-</div>
      <div class="profile-phone" id="pPhone">-</div>
      <span class="profile-role" id="pRole">USER</span>
    </div>
    <div class="stats-mini">
      <div class="stat-mini">
        <div class="stat-mini-label">ì „ì²´ ì¥ë¹„</div>
        <div class="stat-mini-val" id="miniTotal">-</div>
      </div>
      <div class="stat-mini">
        <div class="stat-mini-label">ë‚´ ì˜ˆì•½</div>
        <div class="stat-mini-val" id="miniMine">0</div>
      </div>
    </div>
    <nav>
      <div class="nav-label">ë©”ë‰´</div>
      <button class="nav-item active" id="nav-equipments" onclick="switchTab('equipments')">
        <span class="nav-icon">ğŸ–¥</span> ì¥ë¹„ ëª©ë¡
      </button>
      <button class="nav-item" id="nav-myreservations" onclick="switchTab('myreservations')">
        <span class="nav-icon">ğŸ“‹</span> ë‚´ ì˜ˆì•½ ëª©ë¡
        <span class="nav-count" id="navCount" style="display:none">0</span>
      </button>
    </nav>
  </aside>

  <main>
    <!-- ì¥ë¹„ ëª©ë¡ -->
    <div class="section active" id="section-equipments">
      <div class="page-head">
        <div>
          <div class="page-title">ì¥ë¹„ ëª©ë¡</div>
          <div class="page-sub">ì˜ˆì•½í•˜ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ ë°˜ë‚©ì¼ì„ ì„¤ì •í•˜ê³  ì˜ˆì•½í•˜ì„¸ìš”</div>
        </div>
      </div>
      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-icon blue">ğŸ–¥</div>
          <div><div class="stat-label">ì „ì²´ ì¥ë¹„</div><div class="stat-val blue" id="statTotal">-</div></div>
        </div>
        <div class="stat-card">
          <div class="stat-icon green">âœ…</div>
          <div><div class="stat-label">ì˜ˆì•½ ê°€ëŠ¥</div><div class="stat-val green" id="statAvail">-</div></div>
        </div>
        <div class="stat-card">
          <div class="stat-icon amber">ğŸ“Œ</div>
          <div><div class="stat-label">ì˜ˆì•½ë¨</div><div class="stat-val amber" id="statRes">-</div></div>
        </div>
      </div>
      <div class="toolbar">
        <div class="search-wrap">
          <span class="search-icon">ğŸ”</span>
          <input type="text" id="searchInput" placeholder="ì¥ë¹„ëª…ìœ¼ë¡œ ê²€ìƒ‰..." oninput="filterTable()"/>
        </div>
        <button class="btn-refresh" onclick="loadEquipments()">â†º ìƒˆë¡œê³ ì¹¨</button>
      </div>
      <div class="table-wrap" id="tableWrap">
        <div class="loading-box"><div class="spinner"></div> ì¥ë¹„ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>
    </div>

    <!-- ë‚´ ì˜ˆì•½ ëª©ë¡ -->
    <div class="section" id="section-myreservations">
      <div class="page-head">
        <div>
          <div class="page-title">ë‚´ ì˜ˆì•½ ëª©ë¡</div>
          <div class="page-sub">ì˜ˆì•½ì¼Â·ë°˜ë‚©ì¼ í™•ì¸ ë° ì˜ˆì•½ ì·¨ì†Œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤</div>
        </div>
      </div>
      <div id="myResWrap">
        <div class="loading-box"><div class="spinner"></div> ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>
    </div>
  </main>
</div>

<div class="toast" id="toast"></div>

<script>
  const API = 'http://localhost:8080/api';
  let currentUser   = null;
  let allEquipments = [];
  let pendingReserveId   = null;  // ì˜ˆì•½ ëŒ€ê¸° ì¤‘ì¸ ì¥ë¹„ ID
  let pendingCancelId    = null;  // ì·¨ì†Œ ëŒ€ê¸° ì¤‘ì¸ ì¥ë¹„ ID

  // â”€â”€ í˜„ì¬ ìœ ì € ì¡°íšŒ (ì„¸ì…˜)
  async function fetchMe() {
    try {
      const res = await fetch(`${API}/auth/me`, { credentials: 'include' });
      if (res.status === 401) {
        document.getElementById('unauth').classList.add('show');
        return false;
      }
      currentUser = await res.json();
      renderProfile();
      return true;
    } catch (e) {
      toast('error', 'âš  ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return false;
    }
  }

  function renderProfile() {
    if (!currentUser) return;
    const init = currentUser.name?.[0] || '?';
    ['pAvatar','hAvatar'].forEach(id => document.getElementById(id).textContent = init);
    document.getElementById('pName').textContent  = currentUser.name;
    document.getElementById('hName').textContent  = currentUser.name;
    document.getElementById('pPhone').textContent = currentUser.phone;
    document.getElementById('pRole').textContent  = currentUser.role;
  }

  // â”€â”€ íƒ­ ì „í™˜
  function switchTab(tab) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById('section-' + tab).classList.add('active');
    document.getElementById('nav-' + tab).classList.add('active');
    if (tab === 'myreservations') renderMyReservations();
  }

  // â”€â”€ ì¥ë¹„ ëª©ë¡ ë¡œë“œ
  async function loadEquipments() {
    document.getElementById('tableWrap').innerHTML =
      `<div class="loading-box"><div class="spinner"></div> ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>`;
    try {
      const res = await fetch(`${API}/equipments`, { credentials: 'include' });
      allEquipments = await res.json();
      allEquipments = allEquipments.filter(e => e.status === 'ì •ìƒ');
      updateStats();
      renderTable(allEquipments);
    } catch (e) {
      document.getElementById('tableWrap').innerHTML =
        `<div class="empty-box"><div class="ei">âš ï¸</div><p>ì„œë²„ ì—°ê²° ì‹¤íŒ¨<br>API ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”</p></div>`;
    }
  }

  function updateStats() {
    const total    = allEquipments.length;
    const reserved = allEquipments.filter(e => e.reserved).length;
    const mine     = getMyReservedIds().length;
    document.getElementById('statTotal').textContent = total;
    document.getElementById('statAvail').textContent = total - reserved;
    document.getElementById('statRes').textContent   = reserved;
    document.getElementById('miniTotal').textContent = total;
    document.getElementById('miniMine').textContent  = mine;
    const nc = document.getElementById('navCount');
    nc.textContent   = mine;
    nc.style.display = mine > 0 ? '' : 'none';
  }

  function renderTable(list) {
    if (!list.length) {
      document.getElementById('tableWrap').innerHTML =
        `<div class="empty-box"><div class="ei">ğŸ“­</div><p>ë“±ë¡ëœ ì¥ë¹„ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>`;
      return;
    }
    const myIds = getMyReservedIds();
    const rows  = list.map(eq => {
      const isMine    = myIds.includes(eq.id);
      const statusCls = eq.status === 'ì •ìƒ' ? 'normal' : eq.status === 'ìˆ˜ë¦¬' ? 'repair' : 'broken';
      let btn;
      if (eq.reserved) {
        btn = isMine
          ? `<button class="btn-reserve mine">ë‚´ ì˜ˆì•½</button>`
          : `<button class="btn-reserve off" disabled>ì˜ˆì•½ë¶ˆê°€</button>`;
      } else {
        btn = `<button class="btn-reserve can" onclick="openReserveModal('${eq.id}')">ì˜ˆì•½í•˜ê¸°</button>`;
      }
      return `<tr>
        <td><span class="mono">${eq.id?.slice(0,8)}â€¦</span></td>
        <td>${eq.num}</td>
        <td><strong>${eq.name}</strong></td>
        <td><span class="badge ${statusCls}">${eq.status}</span></td>
        <td><span class="badge ${eq.reserved ? 'rsv-yes' : 'available'}">${eq.reserved ? 'ì˜ˆì•½ë¨' : 'ê°€ëŠ¥'}</span></td>
        <td><span class="mono">${eq.startdate ?? '-'}</span></td>
        <td><span class="mono">${eq.deadline ?? '-'}</span></td>
        <td>${btn}</td>
      </tr>`;
    }).join('');

    document.getElementById('tableWrap').innerHTML = `
      <table>
        <thead>
          <tr>
            <th>ID</th><th>ë²ˆí˜¸</th><th>ì¥ë¹„ëª…</th><th>ìƒíƒœ</th><th>ì˜ˆì•½ì—¬ë¶€</th>
            <th>ì˜ˆì•½ì¼</th><th>ë°˜ë‚©ê¸°í•œ</th><th>ì•¡ì…˜</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>`;
  }

  function filterTable() {
    const q = document.getElementById('searchInput').value.toLowerCase();
    renderTable(allEquipments.filter(e => e.name.toLowerCase().includes(q)));
  }

  // â”€â”€ ì˜ˆì•½ ëª¨ë‹¬
  function openReserveModal(id) {
    const eq = allEquipments.find(e => e.id === id);
    if (!eq) return;
    pendingReserveId = id;

    const today = todayStr();
    document.getElementById('modalEqName').textContent    = eq.name;
    document.getElementById('modalEqMeta').textContent    = `ë²ˆí˜¸: ${eq.num}  |  ìƒíƒœ: ${eq.status}`;
    document.getElementById('modalReservedDate').textContent = today;
    document.getElementById('modalToday').textContent     = today;
    document.getElementById('deadlineInput').value        = '';
    document.getElementById('deadlineInput').min          = today;
    document.getElementById('deadlineHint').textContent   = 'ë°˜ë‚©í•  ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš” (ì˜¤ëŠ˜ ì´í›„)';
    document.getElementById('deadlineHint').style.color   = 'var(--text-dim)';
    document.getElementById('confirmReserveBtn').disabled = true;

    document.getElementById('reserveModal').classList.add('show');
  }

  function closeReserveModal() {
    document.getElementById('reserveModal').classList.remove('show');
    pendingReserveId = null;
  }

  function validateDeadline() {
    const val  = document.getElementById('deadlineInput').value;
    const hint = document.getElementById('deadlineHint');
    const btn  = document.getElementById('confirmReserveBtn');
    if (!val) {
      hint.textContent = 'ë°˜ë‚©í•  ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš” (ì˜¤ëŠ˜ ì´í›„)';
      hint.style.color = 'var(--text-dim)';
      btn.disabled = true;
      return;
    }
    if (val < todayStr()) {
      hint.textContent = 'âš  ì˜¤ëŠ˜ ì´í›„ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”';
      hint.style.color = 'var(--red)';
      btn.disabled = true;
      return;
    }
    hint.textContent = 'âœ“ ë°˜ë‚©ì¼ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤';
    hint.style.color = 'var(--green)';
    btn.disabled = false;
  }

  async function submitReserve() {
    const deadline = document.getElementById('deadlineInput').value;
    if (!deadline || !pendingReserveId) return;

    document.getElementById('confirmReserveBtn').disabled = true;
    document.getElementById('confirmReserveBtn').textContent = 'ì²˜ë¦¬ì¤‘...';

    try {
      const res = await fetch(`${API}/equipments/reserve/${pendingReserveId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ deadline, num: 0, name: '', status: '' })
      });

      if (res.ok) {
        const eq = allEquipments.find(e => e.id === pendingReserveId);
        if (eq) {
          eq.reserved     = true;
          eq.deadline     = deadline;
          eq.startdate = todayStr();
        }
        const myIds = getMyReservedIds();
        if (!myIds.includes(pendingReserveId)) { myIds.push(pendingReserveId); setMyReservedIds(myIds); }
        updateStats();
        renderTable(allEquipments);
        closeReserveModal();
        toast('success', `âœ… "${eq?.name}" ì˜ˆì•½ ì™„ë£Œ!`);
      } else {
        toast('error', 'âŒ ì˜ˆì•½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    } catch (e) {
      toast('error', 'âŒ ì„œë²„ ì—°ê²° ì˜¤ë¥˜');
    } finally {
      document.getElementById('confirmReserveBtn').disabled = false;
      document.getElementById('confirmReserveBtn').textContent = 'ì˜ˆì•½ í™•ì •';
    }
  }

  // â”€â”€ ì˜ˆì•½ ì·¨ì†Œ ëª¨ë‹¬
  function openCancelModal(id) {
    const eq = allEquipments.find(e => e.id === id);
    if (!eq) return;
    pendingCancelId = id;
    document.getElementById('cancelModalDesc').textContent =
      `"${eq.name}" ì¥ë¹„ì˜ ì˜ˆì•½ì´ ì·¨ì†Œë©ë‹ˆë‹¤.\nì˜ˆì•½ì¼ ${eq.startdate ?? '-'} â†’ ë°˜ë‚©ê¸°í•œ ${eq.deadline ?? '-'}`;
    document.getElementById('cancelModal').classList.add('show');
  }

  function closeCancelModal() {
    document.getElementById('cancelModal').classList.remove('show');
    pendingCancelId = null;
  }

  async function submitCancel() {
    if (!pendingCancelId) return;
    try {
      const res = await fetch(`${API}/equipments/cancel/${pendingCancelId}`, {
        method: 'PUT',
        credentials: 'include'
      });
      if (res.ok) {
        const eq = allEquipments.find(e => e.id === pendingCancelId);
        if (eq) { eq.reserved = false; eq.deadline = null; eq.startdate = null; }

        const myIds = getMyReservedIds().filter(id => id !== pendingCancelId);
        setMyReservedIds(myIds);

        updateStats();
        renderTable(allEquipments);
        renderMyReservations();
        closeCancelModal();
        toast('info', `ğŸ—‘ "${eq?.name}" ì˜ˆì•½ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
      } else {
        toast('error', 'âŒ ì·¨ì†Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        closeCancelModal();
      }
    } catch (e) {
      toast('error', 'âŒ ì„œë²„ ì—°ê²° ì˜¤ë¥˜');
      closeCancelModal();
    }
  }

  // â”€â”€ ë‚´ ì˜ˆì•½ ëª©ë¡
  function renderMyReservations() {
    const myIds  = getMyReservedIds();
    const myList = allEquipments.filter(e => myIds.includes(e.id));

    if (!myList.length) {
      document.getElementById('myResWrap').innerHTML =
        `<div class="empty-box"><div class="ei">ğŸ“‹</div><p>ì˜ˆì•½í•œ ì¥ë¹„ê°€ ì—†ìŠµë‹ˆë‹¤<br>ì¥ë¹„ ëª©ë¡ì—ì„œ ì˜ˆì•½í•´ë³´ì„¸ìš”</p></div>`;
      return;
    }

    const today = new Date();
    today.setHours(0,0,0,0);

    document.getElementById('myResWrap').innerHTML = `
      <div class="res-list">
        ${myList.map(eq => {
          const startdate = eq.startdate ? new Date(eq.startdate) : null;

          // ì˜ˆì•½ì¼ ë‹¤ìŒë‚ ë¶€í„° ë°˜ë‚© ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½
          const isNextDay = startdate && today > startdate;

          const btn = isNextDay
            ? `<button class="btn-cancel" style="background:var(--green-bg);color:var(--green);border-color:rgba(46,204,138,.4);" onclick="openReturnModal('${eq.id}')">ë°˜ë‚©í•˜ê¸°</button>`
            : `<button class="btn-cancel" onclick="openCancelModal('${eq.id}')">ì˜ˆì•½ ì·¨ì†Œ</button>`;

          return `
            <div class="res-card">
              <div class="res-icon">ğŸ–¥</div>
              <div class="res-body">
                <div class="res-name">${eq.name}</div>
                <div class="res-dates">
                  <div class="res-date-chip"><span class="label">ì˜ˆì•½ì¼</span>${eq.startdate ?? '-'}</div>
                  <div class="res-date-chip"><span class="label">ë°˜ë‚©ê¸°í•œ</span>${eq.deadline ?? '-'}</div>
                  <div class="res-date-chip"><span class="label">ë²ˆí˜¸</span>${eq.num}</div>
                </div>
              </div>
              ${btn}
            </div>`;
        }).join('')}
      </div>`;
  }
  function openReturnModal(id) {
    const eq = allEquipments.find(e => e.id === id);
    if (!eq) return;
    pendingCancelId = id;
    document.getElementById('cancelModalDesc').textContent =
      `"${eq.name}" ì¥ë¹„ë¥¼ ë°˜ë‚©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
    document.getElementById('cancelModal').classList.add('show');
  }

  // â”€â”€ ì„¸ì…˜ìŠ¤í† ë¦¬ì§€ë¡œ ë‚´ ì˜ˆì•½ ID ê´€ë¦¬
  function getMyReservedIds()       { return JSON.parse(sessionStorage.getItem('myReservedIds') || '[]'); }
  function setMyReservedIds(ids)    { sessionStorage.setItem('myReservedIds', JSON.stringify(ids)); }

  // â”€â”€ ìœ í‹¸
  function todayStr() {
    return new Date().toLocaleDateString('fr-CA'); // yyyy-MM-dd
  }

  // â”€â”€ ë¡œê·¸ì•„ì›ƒ
  async function doLogout() {
    try { await fetch(`${API}/auth/logout`, { method: 'POST', credentials: 'include' }); } catch (e) {}
    sessionStorage.clear();
    toast('info', 'ğŸ‘‹ ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');
    setTimeout(() => location.href = '/login.html', 1000);
  }

  // â”€â”€ í† ìŠ¤íŠ¸
  function toast(type, msg) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.className   = `toast ${type} show`;
    clearTimeout(el._t);
    el._t = setTimeout(() => el.classList.remove('show'), 3000);
  }

  // â”€â”€ ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ë‹«ê¸°
  document.getElementById('reserveModal').addEventListener('click', e => { if(e.target === e.currentTarget) closeReserveModal(); });
  document.getElementById('cancelModal').addEventListener('click',  e => { if(e.target === e.currentTarget) closeCancelModal(); });

  // â”€â”€ ì´ˆê¸°í™”
  (async () => {
    const ok = await fetchMe();
    if (ok) await loadEquipments();
  })();
</script>
</body>
</html>
